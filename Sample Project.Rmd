---
title: "Tuition prediction modeling"
---

```{r}
library(tidyverse)
library(readr)
library(patchwork)
library(ggridges)
library(janitor)
theme_set(theme_bw())
knitr::opts_chunk$set(echo = FALSE) # Prevents code from showing in the pdf.

# Downloaded from https://survey.stackoverflow.co/
education_costs <- read_csv("C:/Users/Лиза/Desktop/DATA100 R/DATA100-FINAL-PROJECT/International_Education_Costs.csv", show_col_types = FALSE)

glimpse(education_costs) #remove later
summary(education_costs)
```

# Introduction

<<I'll use double angle brackets to point out what I'm doing at each point.>>

<<Here, I'm describing the data in general. I want to give the reader enough information to ask the same questions as me, without actually stating my research goals.>>

StackOverflow is the go-to location for developers, data scientists, and students trying to solve coding issues that they are facing. Each year, they survey their users to get an idea of the demographics. In this survey, they include their job, education level, and their income, along with how they learned to code.

# Goals

In this work, I'll look at how education level affects income. I'm restricting my analysis to people who code in R or python who work in a data-related field.

# Basic Data Cleaning

At the first quick glance, the current dataset seems to be usable, but not fully ready for modeling. Several cleaning steps are necessary to ensure that the data is tidy, consistent and suitable for analysis.

First of all, we need to make sure that our variables have appropriate data types: quantitative should be numeric, qualitative should be factor. We selected these variables and mutate them into an appropriate data type.

Second of all, Character columns sometimes contained unnecessary white space (leading or trailing spaces). All character variables were cleaned using str_trim() to ensure consistency when grouping or filtering.

Third of all, the dataset was inspected for missing values. Rows with missing values in essential cost related variables (tuition, rent, insurance, visa fees) were removed, as they would prevent accurate modeling.

Lastly, we created a couple of new variables to better support modeling and analysis: Annual rent (annual_rent), Total annual cost (total_annual_cost) and Local currency tuition with rent (was adjusted based on exchange currency) - these variables can improve predictive performance and provide more meaningful insights.

For further analysis and visualization, we also reshaped cost related variables using pivot_longer(), resulting in cost_type and cost_value columns. It will be useful for comparing cost categories across countries or institutions.
  

```{r}
# Cleaning before modeling
education_cleaned <- education_costs |>
  clean_names() |>
  mutate(across(where(is.character), str_trim)) |>
  mutate(
    country = factor(country),
    city  = factor(city),
    university = factor(university),
    program = factor(program),
    level = factor(level)
  ) |>
  mutate(
    tuition_usd = as.numeric(tuition_usd),
    rent_usd  = as.numeric(rent_usd),
    insurance_usd = as.numeric(insurance_usd),
    visa_fee_usd = as.numeric(visa_fee_usd),
    exchange_rate = as.numeric(exchange_rate)
  ) |>
  mutate(
    annual_rent = rent_usd * 12,
    total_annual_cost = tuition_usd + annual_rent + insurance_usd + visa_fee_usd,
    tuition_local = tuition_usd / exchange_rate,
    rent_local  = rent_usd / exchange_rate
  ) |>
  filter(
    !is.na(tuition_usd),
    !is.na(rent_usd),
    !is.na(insurance_usd),
    !is.na(visa_fee_usd)
  )

education_long <- education_cleaned |>
  pivot_longer(
    cols = c(tuition_usd, rent_usd, insurance_usd, visa_fee_usd),
    names_to = "cost_type",
    values_to = "cost_value"
  )

education_cleaned
education_long
```


# Exploratory Plots

Visualization is an essential part of teh Exploratory Data Analysis. Here, we will explore how does the tuition vary and relate to other factors that could impact it, by using 3 plots.

## Plot 1: How does tuition relate to the living cost index?

```{r}
plot1 <- education_cleaned |> 
  ggplot(aes(x = living_cost_index, y = tuition_usd)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Tuition vs Living Cost Index")
plot1

```

- Countries with higher living costs generally appear to have higher tuition fees. This suggests that cost of living and tuition may be influenced by similar economic factors.

- Although the trend is positive, the points are widely scattered around the trend line. Living cost index alone does not strongly predict tuition. There are likely other important variables influencing tuition

- High tuition but moderate living costs, and Low tuition in countries with relatively high living costs.

Here, we can conclude that this plot shows a large variation. Thus, adding other factors/predictors could improve explaining the differences in tuition.


## Plot 2: Correlation between tuition, living cost index and duration of studying at University

```{r}
library(corrplot)

numeric_education <- education_cleaned |> 
  select(tuition_usd, living_cost_index, duration_years)

corrplot(cor(numeric_education), method = "pie")

```

- The correlation between tuition_usd and living_cost_index is positive and of moderate strength.

- Countries with higher living costs tend to also have higher tuition fees. This suggests tuition may be linked to overall economic factors in the region.

- The relationship between tuition_usd and duration_years appears to be close to zero or only slightly positive/negative, meaning program duration is not a strong driver of tuition in this dataset. It makes sense because in reality many universities charge per-year prices.

It concludes that tuition and index of living cost have a pretty positive correlation, but not extremely strong, but it explains a huge part of variation in tuition and that it is considered an important factor for international students. 

## Plot 3: Distribution of Tuition across programs by countries

```{r, fig.cap="The scatterplot shows how tuition cost (USD) varies with program duration (years), with points colored by continent. It allows you to see both the relationship between duration and tuition, and differences across regions."}
library(countrycode)

education_cleaned <- education_cleaned |>
  mutate(
    continent = countrycode(country, "country.name", "continent")
  )

p3 <- education_cleaned |>
  ggplot(aes(x = duration_years, y = tuition_usd, color = continent)) +
  geom_point(alpha = 0.5) +
  labs(title = "Tuition vs Duration by Continent")
p3
```
- Programs of the same duration can have very different tuition values.

- There is significant overlap between 1-year and 2-year programs.

- Continent Europe: Mostly lower-tuition programs, even longer programs remain relatively affordable, points cluster in the lower tuition range compared to other continents.

- Continent Asia: A broad range of durations, tuition varies widely but tends to sit in the mid-range, some outliers with higher tuition.

- Continents Americas: Typically higher tuition, programs with similar duration cost much more than in Europe or Asia, smaller spread in duration (mostly 1–2 year programs).

- Continent Oceania: very similar to Americas, but with moderate number of long duration programs.

- Continent Africa: generally have lower tuition, and there is a limited variation between duration and tuition. 

Based on this plot, we can conclude that has a weaker linear relationship with tuition, as tuition does not consistently increase with duration_years and there are some overlaps between different years of studying. 

# Exploratory Modeling: Testing

As we move forward with creating a suitable model for predicting the tuition. 

```{r}
set.seed(123)
n <- nrow(education_cleaned)
train_idx <- sample(seq_len(n), size = 0.6 * n)
remaining_idx <- setdiff(seq_len(n), train_idx)
valid_idx <- sample(remaining_idx, size = 0.5 * length(remaining_idx))
test_idx  <- setdiff(remaining_idx, valid_idx)

# data sets
train_data <- education_cleaned[train_idx, ]
valid_data <- education_cleaned[valid_idx, ]
test_data  <- education_cleaned[test_idx, ]
```

Here, we broke down our data set into a standard 60% training, 20% validating and 20% evaluating. 

# Exploratory Modeling: Polynomial regression modeling and choosing right degree

```{r}
set.seed(123)  # ensures reproducibility

# Degrees you want to test
degrees <- 1:10

rmse_values <- numeric(length(degrees))

for (d in degrees) {
  # Fit polynomial model of degree d
  model <- lm(tuition_usd ~ poly(living_cost_index, d, raw = TRUE), 
              data = train_data)
  
  # Predict on validation
  preds <- predict(model, newdata = valid_data)
  
  # Compute RMSE
  rmse_values[d] <- sqrt(mean((valid_data$tuition_usd - preds)^2))
}

rmse_values

best_degree <- degrees[which.min(rmse_values)]
best_degree

plot(degrees, rmse_values, type = "b",
     xlab = "Polynomial Degree",
     ylab = "Validation RMSE",
     main = "RMSE by Polynomial Degree")

```
- The plot seems to show the absolute minimum values 5 and 8 from this range. Degree 5 is preferred because it achieves nearly the same RMSE as degree 8 but with a simpler curve and lower overfitting risk

# Model testing and visualization check

```{r}
# recombine train + valid
train_all <- bind_rows(train_data, valid_data)

# fit final polynomial model (degree 5)
final_model <- lm(tuition_usd ~ poly(living_cost_index, 5, raw = TRUE),
                  data = train_all)

# evaluate on test set
pred_test <- predict(final_model, newdata = test_data)
rmse_test <- sqrt(mean((test_data$tuition_usd - pred_test)^2))
mae_test  <- mean(abs(test_data$tuition_usd - pred_test))
r2_test   <- 1 - sum((test_data$tuition_usd - pred_test)^2) / sum((test_data$tuition_usd - mean(test_data$tuition_usd))^2)

cat("Test RMSE:", rmse_test, "\nTest MAE:", mae_test, "\nTest R2:", r2_test, "\n")

pred_train <- predict(final_model, newdata = train_all)
rmse_train <- sqrt(mean((train_all$tuition_usd - pred_train)^2))
cat("Train RMSE:", rmse_train, " | Test RMSE:", rmse_test, "\n")

# Additional checks
resid <- resid(final_model)
fitted <- fitted(final_model)

# residual vs fitted (explicit)
plot(fitted, resid, pch=20, main="Residuals vs Fitted")
abline(h=0, col="red")

# Shapiro test for normality (note: large samples often reject)
shapiro.test(sample(resid, min(length(resid), 5000)))  # sample if very large


```

We can observe that our Test RMSE is not by much less than Train RMSE => no signs of overfitting. Even though there might be other factors that could lead to getting the random or systematic error between those 2 values, we can conclude that this model generalizes pretty well. 

# Ploting prediction vs actual

```{r}
model2 <- lm(tuition_usd ~ poly(living_cost_index, 5, raw=TRUE) + duration_years + continent, data=train_data)

summary(model2)



```
# Final Predicted Tuition vs Actual Tuition

```{r}
train_data$predicted <- predict(model2, newdata = train_data)

ggplot(train_data, aes(x = predicted, y = tuition_usd)) +
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1, color = "red", linewidth = 1.2) +
  labs(
    title = "Predicted vs Actual Tuition (Final Model)",
    x = "Predicted Tuition (USD)",
    y = "Actual Tuition (USD)"
  ) +
  theme_minimal()

```

- The final model includes: a 5th-degree polynomial of living_cost_index duration_years of study and continent (categorical, 5 categories).

- 